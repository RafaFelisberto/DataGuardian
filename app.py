import streamlit as st
import pandas as pd
import plotly.express as px
from core.file_processor import process_file
from core.detector import SensitiveDataDetector
from core.analyzer import AnomalyAnalyzer
from utils.encryption import DataEncryptor
import datetime

# Configura√ß√£o da p√°gina
st.set_page_config(page_title="DataGuardian", layout="wide")
st.title("üîç DataGuardian - Monitor de Seguran√ßa de Dados")

# Upload do arquivo
uploaded_file = st.file_uploader("Carregue seu arquivo de dados", type=["csv", "json", "txt", "sql"])

if uploaded_file:
    st.write("‚úÖ Arquivo carregado:", uploaded_file.name)
    st.write("üìÅ Tipo do arquivo:", uploaded_file.type)
    try:
        # Processa o arquivo
        df = process_file(uploaded_file)
        if df.empty:
            st.warning("‚ùå Arquivo carregado est√° vazio ou inv√°lido.")
            st.stop()

        # Exibe os dados brutos
        with st.expander("üìÇ Ver Dados Carregados"):
            st.dataframe(df.head(100))

        # Detec√ß√£o de dados sens√≠veis
        detector = SensitiveDataDetector()
        findings = []

        for col in df.columns:
            for text in df[col].astype(str).unique():
                regex_matches = detector.detect_regex(text)
                presidio_matches = detector.detect_ner_presidio(text)
                if regex_matches or presidio_matches:
                    findings.append({
                        "Coluna": col,
                        "Valor": text,
                        "Regex": list(regex_matches.keys()),
                        "Presidio": [f"{t}:{v}" for t, v in presidio_matches]
                    })

        if not findings:
            st.info("‚úÖ Nenhum dado sens√≠vel foi encontrado.")
            st.stop()

        # Exibe os dados sens√≠veis encontrados
        findings_df = pd.DataFrame(findings)
        st.subheader("üìå Dados Sens√≠veis Detectados")
        st.dataframe(findings_df)

        # Visualiza√ß√£o: Distribui√ß√£o de tipos de dados
        st.subheader("üìä Distribui√ß√£o de Dados Sens√≠veis")
        if not findings_df.empty:
            findings_df["Tipo"] = findings_df["Regex"].apply(lambda x: ", ".join(x) if x else "NLP")
            fig = px.histogram(findings_df, x="Tipo", title="Tipos de Dados Sens√≠veis Encontrados")
            st.plotly_chart(fig)

            # Treemap por tipo de dado
            fig_tree = px.treemap(findings_df, path=["Tipo"], title="Distribui√ß√£o Hier√°rquica de Dados")
            st.plotly_chart(fig_tree)

        # Filtro por tipo de dado
        st.sidebar.subheader("üîé Filtros")
        data_types = ["Todos"] + sorted(set(findings_df["Tipo"].str.split(", ").explode()))
        selected_type = st.sidebar.selectbox("Filtrar por Tipo de Dado", data_types)

        if selected_type != "Todos":
            filtered_df = findings_df[findings_df["Tipo"].str.contains(selected_type)]
            if not filtered_df.empty:
                st.subheader(f"üîç Resultados Filtrados: {selected_type}")
                st.dataframe(filtered_df)
            else:
                st.warning(f"‚ö†Ô∏è Nenhum dado encontrado do tipo '{selected_type}'.")

        # Detec√ß√£o de Anomalias
        st.subheader("üö® An√°lise de Acesso Suspeito")
        if "timestamp" in df.columns:
            access_logs = [{
                "timestamp": ts,
                "user": "usuario_teste",
                "ip": "127.0.0.1",
                "access_count": 1,
                "data_accessed": row.to_string(),
                "data_type": "CPF" if "cpf" in row.to_string().lower() else "UNKNOWN"
            } for _, row in df.iterrows() for ts in [row.get("timestamp", datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"))]]

            analyzer = AnomalyAnalyzer()
            anomalies = analyzer.detect_anomalies(access_logs)

            anomaly_records = [a for a in anomalies if a["anomaly"]]
            if anomaly_records:
                st.warning(f"‚ö†Ô∏è Foram encontradas {len(anomaly_records)} anomalias de acesso!")
                for i, record in enumerate(anomaly_records):
                    with st.expander(f"Anomalia #{i+1} - Score: {record['score']:.2f}"):
                        st.json(record)
            else:
                st.success("‚úÖ Nenhuma anomalia de acesso detectada.")
        else:
            st.info("‚ÑπÔ∏è N√£o foi poss√≠vel analisar anomalias: coluna 'timestamp' n√£o encontrada.")

        # Criptografia de Dados Sens√≠veis
        st.subheader("üîí Criptografia de Dados")
        encryptor = DataEncryptor(use_env_key=False)
        sensitive_columns = st.multiselect("Selecione colunas para criptografar", options=df.columns)

        if st.button("Criptografar Dados"):
            encrypted_df = df.copy()
            for col in sensitive_columns:
                encrypted_df = encryptor.encrypt_column(encrypted_df, col)
            st.session_state["encrypted_df"] = encrypted_df
            st.success("‚úÖ Dados sens√≠veis criptografados com sucesso!")

        if "encrypted_df" in st.session_state:
            st.subheader("üîì Dados Criptografados")
            st.dataframe(st.session_state["encrypted_df"].head(100))

            if st.button("Descriptografar Dados"):
                decrypted_df = st.session_state["encrypted_df"].copy()
                for col in sensitive_columns:
                    decrypted_df = encryptor.decrypt_column(decrypted_df, col)
                st.session_state["decrypted_df"] = decrypted_df
                st.success("üîì Dados descriptografados com sucesso!")

        if "decrypted_df" in st.session_state:
            st.subheader("üìÇ Dados Descriptografados")
            st.dataframe(st.session_state["decrypted_df"].head(100))

    except Exception as e:
        st.error(f"‚ùå Ocorreu um erro: {e}")
        st.exception(e)

else:
    st.info("üì• Por favor, carregue um arquivo para come√ßar a an√°lise.")